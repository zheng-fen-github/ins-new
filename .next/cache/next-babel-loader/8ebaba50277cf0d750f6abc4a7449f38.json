{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _JSXStyle from \"styled-jsx/style\";\nvar __jsx = React.createElement;\nimport React, { useState, useEffect } from 'react';\nimport Top from './addPhototop';\nimport Content from './addphotolist';\nimport Form from './postform/form';\nimport AddBu from './addbu';\nimport { useRouter } from 'next/router';\nimport Loading from '../../../public/loading';\nimport Router from 'next/router';\n\nfunction AddPhoto() {\n  var data = useRouter();\n\n  var _useState = useState(null),\n      avthor = _useState[0],\n      setAvthor = _useState[1];\n\n  var _useState2 = useState(null),\n      avthorPhoto = _useState2[0],\n      setAvthorPhoto = _useState2[1];\n\n  var _useState3 = useState(null),\n      acc = _useState3[0],\n      setAcc = _useState3[1];\n\n  useEffect(function () {\n    var account = data.query.account;\n\n    if (!account) {\n      console.log('没有query 查看cookie');\n\n      (function _callee() {\n        var req, _data;\n\n        return _regeneratorRuntime.async(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return _regeneratorRuntime.awrap(fetch('http://localhost:3001/login/cookie/look', {\n                  credentials: \"include\"\n                }));\n\n              case 2:\n                req = _context.sent;\n\n                if (!(req.status === 200)) {\n                  _context.next = 13;\n                  break;\n                }\n\n                _context.next = 6;\n                return _regeneratorRuntime.awrap(req.json());\n\n              case 6:\n                _data = _context.sent;\n                console.log(_data);\n                setAvthor(_data.message.name);\n                setAvthorPhoto(_data.message.photoId);\n                setAcc(_data.account);\n                _context.next = 14;\n                break;\n\n              case 13:\n                Router.push('/');\n\n              case 14:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, null, null, null, Promise);\n      })();\n    } else {\n      setAvthor(account);\n    }\n  }, []);\n\n  var _useState4 = useState([]),\n      PhotoFiles = _useState4[0],\n      setPhotoFiles = _useState4[1];\n\n  var _useState5 = useState(false),\n      fetching = _useState5[0],\n      setFetching = _useState5[1];\n\n  var fileRef = React.createRef(); // file Dom 定义\n\n  var canvasRef;\n\n  var fileClick = function fileClick() {\n    // 添加图片FileDOM 点击事件\n    fileRef.current.click();\n  };\n\n  var uploadPhoto = function uploadPhoto(e) {\n    var reming, formData, filesPromises, files;\n    return _regeneratorRuntime.async(function uploadPhoto$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            e.preventDefault();\n\n            if (!(PhotoFiles.length < 1)) {\n              _context4.next = 6;\n              break;\n            }\n\n            // 检测是否有照片添加\n            reming = document.querySelector('.remind');\n            reming.hidden = false;\n            setTimeout(function () {\n              return reming.hidden = true;\n            }, 2000);\n            return _context4.abrupt(\"return\");\n\n          case 6:\n            //  添加信息和照片到服务器\n            formData = new FormData(e.target);\n            formData[\"delete\"]('photoFile');\n            filesPromises = PhotoFiles.map(function _callee2(photo) {\n              var img, promise, blob, file;\n              return _regeneratorRuntime.async(function _callee2$(_context2) {\n                while (1) {\n                  switch (_context2.prev = _context2.next) {\n                    case 0:\n                      img = new Image(); //裁减图片1比1。\n\n                      img.src = URL.createObjectURL(photo.file);\n                      promise = new Promise(function (resolve) {\n                        img.onload = function () {\n                          var _canvasRef$getContext;\n\n                          var width = img.width,\n                              height = img.height;\n                          var size = width > height ? height : width;\n                          var count = width > height ? width - size : height - size;\n                          var countAr = width > height ? [-count / 2, 0] : [0, -count / 2];\n                          canvasRef.width = size;\n                          canvasRef.height = size;\n\n                          (_canvasRef$getContext = canvasRef.getContext('2d')).drawImage.apply(_canvasRef$getContext, [img].concat(countAr));\n\n                          canvasRef.toBlob(function (blob) {\n                            resolve(blob);\n                          });\n                        };\n                      });\n                      _context2.next = 5;\n                      return _regeneratorRuntime.awrap(promise.then(function (result) {\n                        return blob = result;\n                      }));\n\n                    case 5:\n                      file = new File([blob], photo.file.name, {\n                        type: photo.file.type\n                      });\n                      return _context2.abrupt(\"return\", file);\n\n                    case 7:\n                    case \"end\":\n                      return _context2.stop();\n                  }\n                }\n              }, null, null, null, Promise);\n            });\n            _context4.next = 11;\n            return _regeneratorRuntime.awrap(Promise.all(filesPromises).then(function (file) {\n              return files = file;\n            }));\n\n          case 11:\n            files.forEach(function (file) {\n              formData.append('photoFile', file);\n            });\n            formData.append('userName', avthor);\n            formData.append('acthorPhotoId', avthorPhoto);\n            formData.append('account', acc);\n            setFetching(true);\n\n            (function _callee3() {\n              var require, res;\n\n              return _regeneratorRuntime.async(function _callee3$(_context3) {\n                while (1) {\n                  switch (_context3.prev = _context3.next) {\n                    case 0:\n                      _context3.next = 2;\n                      return _regeneratorRuntime.awrap(fetch('http://localhost:3001/getphoto/post', {\n                        method: 'POST',\n                        body: formData\n                      }));\n\n                    case 2:\n                      require = _context3.sent;\n\n                      if (res.ok) {\n                        setFetching(true);\n                      }\n\n                      _context3.next = 6;\n                      return _regeneratorRuntime.awrap(require.json());\n\n                    case 6:\n                      res = _context3.sent;\n                      if (res) console.log(res);\n\n                    case 8:\n                    case \"end\":\n                      return _context3.stop();\n                  }\n                }\n              }, null, null, null, Promise);\n            })();\n\n          case 17:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  return __jsx(\"div\", {\n    className: \"jsx-1808194380\" + \" \" + 'add-photo'\n  }, !fetching ? __jsx(React.Fragment, null, __jsx(\"div\", {\n    className: \"jsx-1808194380\" + \" \" + \"container\"\n  }, __jsx(Top, null), __jsx(\"form\", {\n    onSubmit: uploadPhoto,\n    className: \"jsx-1808194380\"\n  }, __jsx(Content, {\n    click: fileClick,\n    setPhotoFiles: setPhotoFiles,\n    PhotoFiles: PhotoFiles\n  }), PhotoFiles.length > 0 && __jsx(AddBu, {\n    click: fileClick\n  }), __jsx(Form, {\n    ref: fileRef,\n    setFile: setPhotoFiles\n  }, __jsx(\"div\", {\n    onClick: function onClick(e) {\n      return e.target.hidden = true;\n    },\n    hidden: true,\n    className: \"jsx-1808194380\" + \" \" + \"remind\"\n  }, \"\\u8BF7\\u6DFB\\u52A0\\u81F3\\u5C11\\u4E00\\u5F20\\u7167\\u7247\"))))) : __jsx(Loading, {\n    color: \"#1f2738\"\n  }), __jsx(\"canvas\", {\n    ref: function ref(_ref) {\n      return canvasRef = _ref;\n    },\n    hidden: true,\n    style: {\n      position: 'fixed',\n      left: 0,\n      top: 0,\n      zIndex: 99\n    },\n    className: \"jsx-1808194380\"\n  }), __jsx(_JSXStyle, {\n    id: \"1808194380\"\n  }, [\".add-photo.jsx-1808194380{position:fixed;top:0;left:0;height:100vh;width:100vw;background:#f4f7f9;z-index:10;}\", \".user.jsx-1808194380{position:fixed;top:50%;left:40px;-webkit-transform:translate(0,-50%);-ms-transform:translate(0,-50%);transform:translate(0,-50%);}\", \".container.jsx-1808194380::-webkit-scrollbar{display:none;}\", \".container.jsx-1808194380{height:100%;width:980px;margin:0 auto;background:white;box-shadow:0 0 4px #eee;overflow:auto;padding-bottom:40vh;}\", \"@media (max-width:980px){.container.jsx-1808194380{width:100%;}}\", \".remind.jsx-1808194380{width:90%;height:50px;border-radius:12px;color:white;text-align:center;line-height:50px;font-size:20px;background:red;-webkit-animation:go-jsx-1808194380 .2s;animation:go-jsx-1808194380 .2s;}\", \"@-webkit-keyframes go-jsx-1808194380{0%{-webkit-transform:scale(0.8);-ms-transform:scale(0.8);transform:scale(0.8);}100%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}\", \"@keyframes go-jsx-1808194380{0%{-webkit-transform:scale(0.8);-ms-transform:scale(0.8);transform:scale(0.8);}100%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}\"]));\n}\n\nexport default AddPhoto;","map":null,"metadata":{},"sourceType":"module"}