{"ast":null,"code":"import _JSXStyle from \"styled-jsx/style\";\nvar __jsx = React.createElement;\nimport React, { useState, useEffect } from 'react';\nimport Top from './addPhototop';\nimport Content from './addphotolist';\nimport Form from './postform/form';\nimport AddBu from './addbu';\nimport { useRouter } from 'next/router';\nimport Loading from '../../../public/loading';\nimport Router from 'next/router';\n\nfunction AddPhoto() {\n  const data = useRouter();\n  const {\n    0: avthor,\n    1: setAvthor\n  } = useState(null);\n  const {\n    0: avthorPhoto,\n    1: setAvthorPhoto\n  } = useState(null);\n  const {\n    0: acc,\n    1: setAcc\n  } = useState(null);\n  useEffect(() => {\n    let account = data.query.account;\n\n    if (!account) {\n      console.log('没有query 查看cookie');\n\n      (async () => {\n        let req = await fetch('http://localhost:3001/login/cookie/look', {\n          credentials: \"include\"\n        });\n\n        if (req.status === 200) {\n          let data = await req.json();\n          console.log(data);\n          setAvthor(data.message.name);\n          setAvthorPhoto(data.message.photoId);\n          setAcc(data.account);\n        } else {\n          Router.push('/');\n        }\n      })();\n    } else {\n      setAvthor(account);\n    }\n  }, []);\n  const {\n    0: PhotoFiles,\n    1: setPhotoFiles\n  } = useState([]);\n  const {\n    0: fetching,\n    1: setFetching\n  } = useState(false);\n  const fileRef = React.createRef(); // file Dom 定义\n\n  let canvasRef;\n\n  const fileClick = () => {\n    // 添加图片FileDOM 点击事件\n    fileRef.current.click();\n  };\n\n  const uploadPhoto = async e => {\n    e.preventDefault();\n\n    if (PhotoFiles.length < 1) {\n      // 检测是否有照片添加\n      let reming = document.querySelector('.remind');\n      reming.hidden = false;\n      setTimeout(() => reming.hidden = true, 2000);\n      return;\n    } //  添加信息和照片到服务器\n\n\n    const formData = new FormData(e.target);\n    formData.delete('photoFile');\n    let filesPromises = PhotoFiles.map(async photo => {\n      let img = new Image(); //裁减图片1比1。\n\n      img.src = URL.createObjectURL(photo.file);\n      let promise = new Promise(resolve => {\n        img.onload = () => {\n          let {\n            width,\n            height\n          } = img;\n          let size = width > height ? height : width;\n          let count = width > height ? width - size : height - size;\n          let countAr = width > height ? [-count / 2, 0] : [0, -count / 2];\n          canvasRef.width = size;\n          canvasRef.height = size;\n          canvasRef.getContext('2d').drawImage(img, ...countAr);\n          canvasRef.toBlob(blob => {\n            resolve(blob);\n          });\n        };\n      });\n      let blob;\n      await promise.then(result => blob = result);\n      let file = new File([blob], photo.file.name, {\n        type: photo.file.type\n      });\n      return file;\n    });\n    let files;\n    await Promise.all(filesPromises).then(file => files = file);\n    files.forEach(file => {\n      formData.append('photoFile', file);\n    });\n    formData.append('userName', avthor);\n    formData.append('acthorPhotoId', avthorPhoto);\n    formData.append('account', acc);\n    setFetching(true);\n\n    (async () => {\n      // setFetching(true);\n      let require = await fetch('http://localhost:3001/getphoto/post', {\n        method: 'POST',\n        body: formData\n      });\n\n      if (res.ok) {\n        setFetching(true);\n      }\n\n      let res = await require.json();\n      if (res) console.log(res);\n    })();\n  };\n\n  return __jsx(\"div\", {\n    className: \"jsx-1808194380\" + \" \" + 'add-photo'\n  }, !fetching ? __jsx(React.Fragment, null, __jsx(\"div\", {\n    className: \"jsx-1808194380\" + \" \" + \"container\"\n  }, __jsx(Top, null), __jsx(\"form\", {\n    onSubmit: uploadPhoto,\n    className: \"jsx-1808194380\"\n  }, __jsx(Content, {\n    click: fileClick,\n    setPhotoFiles: setPhotoFiles,\n    PhotoFiles: PhotoFiles\n  }), PhotoFiles.length > 0 && __jsx(AddBu, {\n    click: fileClick\n  }), __jsx(Form, {\n    ref: fileRef,\n    setFile: setPhotoFiles\n  }, __jsx(\"div\", {\n    onClick: e => e.target.hidden = true,\n    hidden: true,\n    className: \"jsx-1808194380\" + \" \" + \"remind\"\n  }, \"\\u8BF7\\u6DFB\\u52A0\\u81F3\\u5C11\\u4E00\\u5F20\\u7167\\u7247\"))))) : __jsx(Loading, {\n    color: \"#1f2738\"\n  }), __jsx(\"canvas\", {\n    ref: ref => canvasRef = ref,\n    hidden: true,\n    style: {\n      position: 'fixed',\n      left: 0,\n      top: 0,\n      zIndex: 99\n    },\n    className: \"jsx-1808194380\"\n  }), __jsx(_JSXStyle, {\n    id: \"1808194380\"\n  }, [\".add-photo.jsx-1808194380{position:fixed;top:0;left:0;height:100vh;width:100vw;background:#f4f7f9;z-index:10;}\", \".user.jsx-1808194380{position:fixed;top:50%;left:40px;-webkit-transform:translate(0,-50%);-ms-transform:translate(0,-50%);transform:translate(0,-50%);}\", \".container.jsx-1808194380::-webkit-scrollbar{display:none;}\", \".container.jsx-1808194380{height:100%;width:980px;margin:0 auto;background:white;box-shadow:0 0 4px #eee;overflow:auto;padding-bottom:40vh;}\", \"@media (max-width:980px){.container.jsx-1808194380{width:100%;}}\", \".remind.jsx-1808194380{width:90%;height:50px;border-radius:12px;color:white;text-align:center;line-height:50px;font-size:20px;background:red;-webkit-animation:go-jsx-1808194380 .2s;animation:go-jsx-1808194380 .2s;}\", \"@-webkit-keyframes go-jsx-1808194380{0%{-webkit-transform:scale(0.8);-ms-transform:scale(0.8);transform:scale(0.8);}100%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}\", \"@keyframes go-jsx-1808194380{0%{-webkit-transform:scale(0.8);-ms-transform:scale(0.8);transform:scale(0.8);}100%{-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);}}\"]));\n}\n\nexport default AddPhoto;","map":null,"metadata":{},"sourceType":"module"}